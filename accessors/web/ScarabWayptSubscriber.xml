<class name="ScarabWayptSubscriber" extends="org.terraswarm.JSAccessor">
  <version>0.1 $Date: 2015-06-03 09:13:24 -0700 (Wed, 3 June 2015) $</version>
  <author>Marcus Pan</author>
  <input
    name="server"
    value="localhost"
    type="string"
    description="The IP address or domain name of the server."/>
  <input
    name="port"
    value="9090"
    type="number"
    description="The port that the web socket server listens to."/>
  <output
    name="position"
    description="The current xy coordinates"/>
  <require name="webSocket"/>   
  <description type="text/html">
    <![CDATA[
This accessor connects sets up a web socket and connects to rosbridge server, running on Scarab's ROS host. 
This accessor subscribes to the topic "/pose", published by Scarab,and extracts the current x, y coordinates from the JSON object it receives. 
When wrapup() is invoked, this accessor closes the connection.
  ]]>
  </description>
  <script type="text/javascript">
    // <![CDATA[
  var WebSocket = require('webSocket');
  var client = null;
  var server = get('server');
  var port = get('port');

  exports.initialize = function() {
    client = new WebSocket.Client({'host':server, 'port':port});
    client.on('open', onOpen);
    client.on('message', onMessage);
    client.on('close', onClose);
    client.on('error', onError);
    console.log('initialized');
  }

  function subscribe(topic) {
    var data = 
      { 
        'op' : 'subscribe',
        'topic': topic
      };  
    client.send(data);
  }

  function onOpen() {
    console.log('Status: Connected to '+ server + ' on port ' + port);
    subscribe('/pose');
  }
     
  
  function onClose(message) {
    console.log('Status: Connection closed: ' + message);
  }
  
  function onError(message) {
    console.error(message);
    throw(message);
  }
  
  function onMessage(message) {
    var position = [message.msg.pose.position.x,
                    message.msg.pose.position.y];
    console.log('Received coords: (' + position[0] + 
                ', ' + position[1] + ')');
    send('position', position);
  } 

  function wrapup() {
    if (client != null) {
      console.log('Closing');
      client.close();
    }
  }
    // ]]>
  </script>
</class>

