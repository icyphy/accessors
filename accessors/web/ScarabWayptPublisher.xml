<class name="ScarabWayptPublisher" extends="org.terraswarm.JSAccessor">
  <version>0.1 $Date: 2015-06-03 09:13:24 -0700 (Wed, 3 June 2015) $</version>
  <author>Marcus Pan</author>
  <input
    name="server"
    value="localhost"
    type="string"
    description="The IP address or domain name of the server."/>
  <input
    name="port"
    value="9090"
    type="number"
    description="The port that the web socket server listens to."/>
  <input
    name="position"
    value="{0.0, 0.0}"
    description="The waypoint xy coordinates"/>
  <require name="webSocket"/>   
  <description type="text/html">
    <![CDATA[
This accessor publishes waypoints to the Scarab robot through a web socket. ROS running on the Scarab connects to the web socket through rosbridge. 
The inputs are an array of 2 floats, {x, y}.
When wrapup() is invoked, this accessor closes the connection.
  ]]>
  </description>
  <script type="text/javascript">
    // <![CDATA[
  var WebSocket = require('webSocket');
  var client = null;
  var server = get('server');
  var port = get('port');

  exports.initialize = function() {
    client = new WebSocket.Client({'host':server, 'port':port});
    client.on('open', onOpen);
    client.on('message', onMessage);
    client.on('close', onClose);
    client.on('error', onError);
    console.log('initialized');
  }

  function onOpen() {
    console.log('Status: Connected to '+ server + 
                ' on port ' + port);
    addInputHandler('position', publishWaypt);
  }
  
  function onClose(message) {
    console.log('Status: Connection closed: ' + message);
  }
  
  function onError(message) {
    console.error(message);
    throw(message);
  }
  
  function onMessage(message) {
    var msg_string = JSON.stringify(message);
    console.log('Received: ' + msg_string);
  } 

  function publishWaypt() {
    var position = get('position');
    var msg = {
      "header": {
        "seq": 0,
        "stamp": {
          "secs": 0,
          "nsecs": 0  
        },
        "frame_id": "map_hokuyo"    
      },
      "pose": {
        "position": {
          "x": position[0],
          "y": position[1],
          "z": 0.0,
        },
        "orientation": {
          "x": 0.0,
          "y": 0.0,
          "z": 0.0,
          "w": 1.0 
        }
      }
    }
    var data = 
      { 
        "op" : "publish",
        "topic": "/goal", 
        "msg" : msg
      };  
    console.log('publishing waypoint: (' + position[0] + 
                ', ' + position[1] + ')');
    client.send(data);
  }

  function wrapup() {
    if (client != null) {
      console.log('Closing');
      client.close();
    }
  }
    // ]]>
  </script>
</class>

